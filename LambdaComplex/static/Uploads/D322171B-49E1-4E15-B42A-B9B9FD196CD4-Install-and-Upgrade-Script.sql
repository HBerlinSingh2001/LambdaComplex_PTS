/*******************************************************

Overview: 

1) Enables clr functionality
2) Sets an Asymetric Key and Login
3) Downloads and restores SQLHTTP database/assembly 

Prerequisites: 

1) SQL Server 2008 or higher
2) .Net Framework 3.5 or higher
3) SysAdmin Permissions

*********************************************************/

SET NOCOUNT ON
SET XACT_ABORT ON

DECLARE @ErrorMessage varchar(4000)

IF IS_SRVROLEMEMBER('sysadmin', SYSTEM_USER) = 0
	BEGIN
		SET @ErrorMessage = 'You must be logged in with sysadmin permissions to run this script'
		RAISERROR(@ErrorMessage, 16, 1)
		RETURN
	END
ELSE
	BEGIN
		
		USE master
		
		--Retrieve SQL Server version to ensure compatibility
		DECLARE @ver nvarchar(128)
		SET @ver = CAST(serverproperty('ProductVersion') AS nvarchar)
		SET @ver = SUBSTRING(@ver, 1, CHARINDEX('.', @ver))
					+ SUBSTRING(@ver, CHARINDEX('.', @ver) + 1, CHARINDEX('.', @ver) - 2)

		IF ISNUMERIC(@ver) = 0
			BEGIN
				RAISERROR('SQL Server Version Not Supported', 16, 1) 
				RETURN
			END

		IF CONVERT(float, @ver) < 10.0
			BEGIN
				RAISERROR('SQL Server Version Not Supported', 16, 1)
				RETURN
			END

		--Determine whether the SQL Server instance is 32-bit or 64-bit
		DECLARE @Is64bit bit
		IF CONVERT(varchar(200), SERVERPROPERTY('Edition')) LIKE '%64-bit%'
			BEGIN
				SET @Is64bit = 1 --True
			END
		ELSE
			BEGIN
				SET @Is64bit = 0 --False
			END

		--Determine .Net Framework Version installed
		--This error should be ignored: "RegOpenKeyEx() returned error 2, 'The system cannot find the file specified.'
		DECLARE @DotNetVersion varchar(255)

		IF CONVERT(float, @ver) > 10.5
			BEGIN
				EXEC master..xp_regread	'HKEY_LOCAL_MACHINE',
										'SOFTWARE\Microsoft\NET Framework Setup\NDP\v4\Full',
										'Version',
										@DotNetVersion OUTPUT
			END
		
		IF @DotNetVersion IS NULL
			BEGIN
				EXEC master..xp_regread	'HKEY_LOCAL_MACHINE',
										'SOFTWARE\Microsoft\NET Framework Setup\NDP\v3.5',
										'Version',
										@DotNetVersion OUTPUT
			END

		IF @DotNetVersion IS NULL
			BEGIN
				EXEC master..xp_regread	'HKEY_LOCAL_MACHINE',
										'SOFTWARE\Microsoft\NET Framework Setup\NDP',
										'Version',
										@DotNetVersion OUTPUT
			END


		IF CONVERT(int, LEFT(REPLACE(ISNULL(@DotNetVersion, '0'), '.', ''), 3)) < 350
			BEGIN
				RAISERROR('.Net Framework 3.5 or higher is required', 16, 1)
				RETURN
			END
			
		--Verify that there is no other database that is using the SQLHTTP.mdf and SQLHTTP.ldf file names
		IF EXISTS (	SELECT *
					FROM sys.databases D
					INNER JOIN sys.master_files MF
						ON D.database_id = MF.database_id
					WHERE (MF.physical_name LIKE '%\SQLHTTP.mdf'
					OR MF.physical_name LIKE '%\SQLHTTP.ldf')
					AND D.name <> 'SQLHTTP')
			BEGIN
				RAISERROR('SQLHTTP named database files are associated with another database', 16, 1)
				RETURN
			END

		--Retrieve the path to the database files of an existing SQLHTTP database.  If SQLHTTP does not exist, then the path to the master database files.
		DECLARE @DataPath nvarchar(512)
		DECLARE @LogPath nvarchar(512)

		IF EXISTS (	SELECT *
					FROM sys.databases
					WHERE name = 'SQLHTTP')
			BEGIN
				--But first check that there are mo open connections to the SQLHTTP database
				IF EXISTS(	SELECT *
							FROM master..sysprocesses P
							INNER JOIN master..sysdatabases D
								ON P.dbid = D.dbid
							WHERE D.name = 'SQLHTTP')
					BEGIN
						DECLARE @AgentList varchar(MAX)

						BEGIN TRY
							SELECT @AgentList = REPLACE(	STUFF((	SELECT '|' + HostName + ' (' + IPAddr + ')'
							FROM SQLHTTP.net.________Agents
							WHERE LastUpdatedDateTime > DATEADD(SECOND, -2 * (TasksTimerInterval + QueueTimerInterval), GETDATE())
							ORDER BY HostName
							FOR XML PATH('')
							), 1, 2, ''), '|', CHAR(13))
						END TRY
						BEGIN CATCH
							--Do nothing
						END CATCH

						SET @AgentList = ISNULL(@AgentList, '')

						SET @ErrorMessage = CHAR(13) + 'SQLHTTP database is in use. Please terminate all existing connections.'
											+ CHAR(13)

						IF LEN(@ErrorMessage) + LEN(@AgentList) < 3900 AND @AgentList <> ''
							BEGIN
								SET @ErrorMessage = @ErrorMessage
											+ CHAR(13) + '1) Stop SQLHTTP Agent Service(s)'
											+ CHAR(13) + '2) Close and Exit SQLHTTP Agent Manager(s)'
											+ CHAR(13)
											+ CHAR(13) + 'SQLHTTP Agents:'
											+ CHAR(13) + CHAR(13)
											+ @AgentList
							END
						
											
						RAISERROR(@ErrorMessage, 16, 1)
						RETURN
					END


				SELECT @DataPath = LEFT(physical_name, LEN(physical_name) - 11) 
				FROM sys.databases D
				INNER JOIN sys.master_files MF
					ON D.database_id = MF.database_id
				WHERE D.name = 'SQLHTTP'
				AND MF.[type] = 0

				SELECT @LogPath = LEFT(physical_name, LEN(physical_name) - 11) 
				FROM sys.databases D
				INNER JOIN sys.master_files MF
					ON D.database_id = MF.database_id
				WHERE D.name = 'SQLHTTP'
				AND MF.[type] = 1
			END
		ELSE
			BEGIN
				SELECT @DataPath = LEFT(physical_name, LEN(physical_name) - 10) 
				FROM sys.databases D
				INNER JOIN sys.master_files MF
					ON D.database_id = MF.database_id
				WHERE D.name = 'master'
				AND MF.[type] = 0

				SELECT @LogPath = LEFT(physical_name, LEN(physical_name) - 11) 
				FROM sys.databases D
				INNER JOIN sys.master_files MF
					ON D.database_id = MF.database_id
				WHERE D.name = 'master'
				AND MF.[type] = 1
			END

		DECLARE @ServerName char(17)
		SET @ServerName = '(' + REPLACE(@@SERVERNAME, '\' + @@SERVICENAME, '') + ')'

		PRINT '********************************************************'
		PRINT '*   Please ensure firewall access to all SQLHTTP.net   *'
		PRINT '*   subdomains from this SQL Server ' + @ServerName + '  *'
		PRINT '********************************************************'

		--Enable CLR functionality
		EXEC sp_executesql N'EXEC sp_configure ''clr enabled'',1'
		EXEC sp_executesql N'RECONFIGURE'

		--Verify, and if neccessary, remove a specifically named login that was previousy associated with a SQLHTTP database
		IF EXISTS(	SELECT *
					FROM syslogins
					WHERE name = 'SQLHTTPAsymetricKeyLogin')
			BEGIN
				DROP LOGIN SQLHTTPAsymetricKeyLogin
			END

		--Verify, and if neccessary, remove a specifically named Assymetric Key that was previousy associated with a SQLHTTP database
		IF EXISTS(	SELECT *
					FROM sys.asymmetric_keys
					WHERE name = 'SQLHTTPAsymetricKey')
			BEGIN
				DROP ASYMMETRIC KEY [SQLHTTPAsymetricKey]
			END

		--Verify, and if neccessary, remove a specifically named CLR Stored Procedure that was previousy associated with a SQLHTTP database
		IF EXISTS(	SELECT *
					FROM sys.procedures
					WHERE name = 'SQLHTTPDownload')
			BEGIN
				DROP PROCEDURE SQLHTTPDownload
			END

		--Verify, and if neccessary, remove a specifically named CLR Function that was previousy associated with a SQLHTTP database
		IF EXISTS(	SELECT *
					FROM sys.objects
					WHERE type = 'FS' --IN ('FN', 'IF', 'TF') 
					AND name = 'SQLHttpTempPath')
			BEGIN
				DROP FUNCTION SQLHttpTempPath
			END

		--Verify, and if neccessary, remove a specifically named CLR Assembly that was previousy associated with a SQLHTTP database
		IF EXISTS(	SELECT *
					FROM sys.assemblies
					WHERE name = 'SQLHTTP_Install')
			BEGIN
				DROP ASSEMBLY SQLHTTP_Install
			END

		DECLARE @Master_is_trustworthy_on bit

		--Retrieve the master database's trustworthy flag
		SELECT @Master_is_trustworthy_on = is_trustworthy_on
		FROM sys.databases
		WHERE name = 'master'

		--Temporarily set the master database's trustworthy flag to ON
		IF @Master_is_trustworthy_on = 0
			BEGIN
				ALTER DATABASE master SET TRUSTWORTHY ON
			END

		DECLARE @SQL nvarchar(MAX)

		IF CONVERT(float, @ver) = 10.5 --SQL Server 2008 R2
		OR CONVERT(int, LEFT(REPLACE(@DotNetVersion, '.', ''), 3)) < 450
			BEGIN
				--Utilizing .Net Framework 3.5
				SET @SQL = '
				CREATE ASSEMBLY SQLHTTP_Install
				FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300BC63625A0000000000000000E0000E210B010B00001C00000020000000000000323B00000020000000400000000040000020000000020000040000000000000004000000000000000080000000020000D3E50000030040850000100000100000000010000010000000000000100000000000000000000000D83A000057000000006000007C03000000000000000000000000000000000000004000000C000000CC2500001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000381B000000200000001C000000020000000000000000000000000000200000602E72656C6F6300000C0000000040000000020000001E0000000000000000000000000000400000422E727372630000007C0300000060000000040000002000000000000000000000000000004000004000000000000000000000000000000000143B00000000000048000000020005008C2600004C14000009000000000000000000000000000000CC24000000010000000000000000000000000000000000000000000000000000000000000000000003300900070000000000000002280F00000A2A001B3006004203000001000011037E03000004280700000625268111000001725B0000700A72610000700A281000000A2526726700007006280800000625266F1100000A7289000070731200000A0C72B900007008731300000A0D09731400000A1304731500000A1305110411056F1600000A2526261D280C0000062526131311131606A21113177288040070A211131811056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A2526728C0400706F1B00000A25266F1C00000A2526A21113197288040070A211131A11056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A2526729E0400706F1B00000A25266F1C00000A2526281D00000A25261F32321A1D4501000000F6FFFFFF172D06D0020000062672B00400702B0572B6040070A211131B7288040070A211131C11056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A252672BC0400706F1B00000A25266F1C00000A2526A21113280A00000625260BDE14092C10184501000000F6FFFFFF096F1E00000ADCDE14082C10174501000000F6FFFFFF086F1E00000ADC7E040000041306731F00000A13077E02000004130872CC040070282000000A2526280B000006252613091109176F2100000A110972060500706F2200000A110972100500706F2300000A1107076F2400000A2526130A1109110A280D0000062526696A6F2500000A11096F2600000A252625130813141108110A16110A280D0000062526696F2700000ADE1611142C111B4501000000F6FFFFFF11146F1E00000ADC11096F2800000A25262806000006252613067E02000004130B7E05000004130C11066F2900000A2526130B110B732A00000A130C7E01000004130D110B130E732B00000A130F1613102000040000280900000625261311110E11111620000400006F2C00000A25261310110F11111611106F2700000A110E6F2D00000A25262C19174501000000F6FFFFFF11101630B91B4501000000F6FFFFFF110F6F2E00000A2526130DDE16110F2C11194501000000F6FFFFFF110F6F1E00000ADCDE16110E2C111D4501000000F6FFFFFF110E6F1E00000ADC110C6F2F00000A110B6F3000000A02110D283100000ADE1A13120311126F3200000A2526280700000625268111000001DE002A000041940000020000004E000000200100006E0100001400000000000000020000004200000042010000840100001400000000000000020000000E02000016000000240200001600000000000000020000008002000061000000E10200001600000000000000020000007902000080000000F902000016000000000000000000000037000000F0020000270300001A0000001400000103300900070000000000000002283300000A2A0003300900070000000000000002280F00000A2A00033009000D00000000000000283400000A2526733500000A2A0000001E02741F0000012A1E02283600000A2A220203283700000A2A0000001E028D070000012A1E02283800000A2A1E02741E0000012A1E028D310000012A0E028E2A139C1824FDA213E329A53661C1F985931DFE133C12750678FD00A030EE987A634843D76EB283CCF73B4B0639E50025E0600E8B33E83575CB2F2C6FDE3C21E783659A554BAF30118937400BD08530BB0380979615FAB37E1321A8F1E31BF4BD8A3EBEEF487025A5AF36F18302CDCEBD680528F6DF68518DB7AF6EDD0505784750029855FB5E87F13F35E0C910360EC6CAD083C92BE733C505FF3D68394612BE5B91E4381E7A97D2EB2EB9C09B2D98441232CC6B1615DE2CAD0EC43BD62B9B35DBAA0517A1F49B62C671B3FB6905A8E1A61CCA7997EF2A95AEFAF52536D7CD735504E1A20ABC2C46BE0C8741A9A5C44AE9EFB655D4AD56A3D09262BAF9E1DA381500000000BC63625A0000000002000000A2000000E8250000E807000052534453F1A47CB840389D41A1F0FAB08C008B8C01000000433A5C55736572735C41646D696E5C446F63756D656E74735C56697375616C2053747564696F20323031355C50726F6A656374735C53514C485454505C53514C485454505F496E7374616C6C5C43727970746F4F626675736361746F725C43727970746F4F626675736361746F725F4F75747075745C53514C487474705F496E7374616C6C2E70646200000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000094050000237E0000000600000406000023537472696E677300000000040C0000100000002347554944000000140C0000E402000023426C6F62000000F80E000054050000235553000000000002000001571502000900000000FA013300020000010000003500000011000000050000000D0000000C000000380000000F000000010000000100000003000000000011000100000000000A0041004C000A0067004C000A007C004C000A0084004C0006009A003A000600A4003A000600AC003A000A00B100BD000A00D0002E000A00D8002E000A00EA002E000A00F2002E000A00FC002E000A0010011B010A0031011B010A003F011B010A004E01580106006D0181014B00940100000600A3013A000600AD013A000600B9013A000600BF013A000600C501CA010600D401CA010600E101CA010600E601CA010600ED01CA010600FA01CA010E00050214020E001F0214020E002F0214020E003A021402060046023A0006004D0266020600780266020600970266020600B20266020600CB0266020600E802660206000503660206001E0366020600350366020600500366020600690389030600A90389030600C70389030600DF03EC0306000B043A00060012041B04060027041B04060034043A0006003C043A000001000041040000000001000100010010004A040000890001000100000010005B04710415000100030001001000730400008900010004000001000088047104890001000600000100008A047104890001000700000100008C047104890002000700000100008E047104890003000700000100009004710489000300080000010000920471048900030009000001000094047104890003000A000001000096047104890003000B000001000098047104890004000B00000100009A047104890005000B00000100009C047104890006000B00000100009E047104890006000C0000010000A0047104890006000D00130096044801130096044C01130096046801130096046B01130096046F015020000000008618A2042C0101006420000000009600A804300101004824000000008618A204380103005C24000000008618A2042C0104007024000000009600D2043D0104008C2400000000930096044201040094240000000093009604500105009C24000000009300960456010600A82400000000930096045C010800B024000000009300960462010900B824000000009300960473010A00C024000000009300960479010B00C82400000000930096047F010C0000000100B80402000200C10400000100CE040000010000000000010000000000010000000000020000000000010000000000010000000000010000000000010000000000010000002100A2042C011100A2042C014901A20438015101A20438013901A20438012101A20438011901A20438014101A20438017101A2042C015901A20438012901A20438019100A2041C026901A2042B027901A2042C011101A2042C010900E2045B021900EB0438017900A20438017100A20460028100A20467025900A2042C014100F0046D025900F5047302690000057802610009057E02510000058302490000058902110112058E02B1001B059202A90021052C019901A2042C01010129059702F10030059E0201013E05380101014905380191015905A30201016205A90201017405AE02D9008505B30201018B05BB0209019705AE02E100A204C102C900A2042C01D900A905C702D900AE05CF02C900BA05D302E900C2052C01D900C2052C01C100C805D802A100D6058E022900A2042C01D100E205DF028900A20438018900EE0550018901FA0556018901FA0562012E005300B4012E004B00D9012E00730085012E005B00F8012E001A00B4012E006B0022022E00630013022E0023009F012E001B008A012E004300CC012E003B00BA012E003300B4012E002B00B40140000B008501A00013008501300204800000000005000000000001000000010001000000020000000000000000000000230125000000000002000000000000000000000023012E000000000002000000000000000000000023013A00000000000053514C487474705F496E7374616C6C0053514C487474705F496E7374616C6C2E646C6C006D73636F726C69620053797374656D2E446174610053797374656D0053716C436F6E74657874004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E4174747269627574650053716C506970650053716C50726F6365647572654174747269627574650041747472696275746500426F6F6C65616E00427974650044617461416461707465720053797374656D2E446174612E436F6D6D6F6E0044617461526F770044617461526F77436F6C6C656374696F6E004461746153657400446174615461626C6500446174615461626C65436F6C6C656374696F6E0053716C436F6D6D616E640053797374656D2E446174612E53716C436C69656E740053716C436F6E6E656374696F6E0053716C44617461416461707465720053716C537472696E670053797374656D2E446174612E53716C54797065730044656275676761626C654174747269627574650053797374656D2E446961676E6F737469637300446562756767696E674D6F64657300457863657074696F6E0049446973706F7361626C6500496E74333200496E7436340046696C650053797374656D2E494F004D656D6F727953747265616D00506174680053747265616D0053747265616D52656164657200546578745265616465720048747470576562526571756573740053797374656D2E4E65740048747470576562526573706F6E7365005765625265717565737400576562526573706F6E7365004F626A65637400417373656D626C79436F6D70616E794174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7943756C7475726541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7956657273696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650053797374656D2E52756E74696D652E436F6D70696C657253657276696365730052756E74696D65436F6D7061746962696C697479417474726962757465005375707072657373496C6461736D417474726962757465004F75744174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300537472696E6700456E636F64696E670053797374656D2E546578740055544638456E636F64696E670055496E7450747200566F6964003C4D6F64756C653E0053746F72656450726F6365647572657300417373656D626C79496E666F41747472696275746500410055736572446566696E656446756E6374696F6E73000300050006000E000F001300140015001D001F0009000A000C002E63746F720053514C48545450446F776E6C6F61640046696C6550617468004572726F724D657373616765007374720053514C4874747054656D7050617468006765745F506970650053656E640046696C6C006765745F5461626C6573006765745F4974656D006765745F526F777300546F537472696E6700506172736500446973706F736500437265617465007365745F4B656570416C697665007365745F4D6574686F64007365745F436F6E74656E7454797065004765744279746573007365745F436F6E74656E744C656E677468004765745265717565737453747265616D00577269746500476574526573706F6E736500476574526573706F6E736553747265616D0052656164006765745F43616E5265616400546F417272617900436C6F7365005772697465416C6C4279746573006765745F4D6573736167650047657454656D7050617468006F705F496D706C6963697400436F6E63617400000000560EE0F3B6DEBD4991F90E47D153F72B008120002400000480000014010000060200000024000052534131000800000100010067C263DAE0DDE3344B0B28942788B1F499B064908CA1A203449C3B1E161D62C708D3833FB0637B47190FE9831D1AE017FD23EE18954263003DED637B1A9B1706E2C1FC02EB69B69B57EB2F316F7DC1152C787277C97A9966106F915C357FD14A56BFE4F2AFAFB678E70FA159FD1F8134347CD3A7092C81BF0926D13D5272B6B7B73DC126DA95D54542F38C032CA8EEC9B2A80831E1321248DC0EF795B16CFFA26FE4E2F4CE9E725D77101AEFC37E780D98DC26CF0097C5985122086B00EB69F10394A322392736496DA678ABAB057A6E6AB21F5AA203A5B28337AA6E3CC5A6F0589E78E70DDD768A43CC5B8AFE366ADC1B7B3C93B049EAEA15C0835AFE9B02AA08B77A5C561934E08903200001070002010E101145042001010E0400001145050001127D1C03061D050306126D05000111450E0500020E0E0E0500011D05080500010E1D0E02060E0306127D0306127105000112791C0500011D0E08050001191D0504010000001401000F53514C4854545020496E7374616C6C00001401000F53514C4874747020496E7374616C6C00000501000000001101000C53514C485454502C204C4C4300000C010007302E352E302E3000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773011A01001528432920323031372053514C485454502C204C4C43000008010002000000000005200101114D08010008000000000004200101082A07150E0E123D12391241122D127D1280CD126D12791D05126D12711D05126D1265081D0512511D0E126D040000120D062002010E123D05200101123905200108122D042000123505200112310804200012290520011225080420011C0E0320000E040001080E0600011280810E04200101020520011D050E042001010A042000126D072003011D05080805200012808505200101126D072003081D050808032000020420001D05060002010E1D050300000E0000591100220033004400390042003900340041003900380042002D0037003600410038002D0034003800310030002D0042003100410030002D00340042004500370043003400460039004300390038004400410032002300140001055800580000053300350000212E004E006500740020004600720061006D00650077006F0072006B003A002000002F63006F006E007400650078007400200063006F006E006E0065006300740069006F006E003D0074007200750065000083CD530045004C0045004300540020004300410053005400280027003C007300650067006D0065006E0074003E00270020002B0020005200450050004C00410043004500280043004F004E0056004500520054002800760061007200630068006100720028003200300029002C002000530045005200560045005200500052004F005000450052005400590028002700500072006F006400750063007400560065007200730069006F006E002700290029002C00200027002E0027002C00200027003C002F007300650067006D0065006E0074003E003C007300650067006D0065006E0074003E002700290020002B00200027003C002F007300650067006D0065006E0074003E002700200041005300200058004D004C0029002E00760061006C00750065002800270028002F007300650067006D0065006E00740029005B0031005D0027002C00200027007600610072006300680061007200280031003200380029002700290020004100530020005600650072004D0061006A006F0072002C0020004300410053005400280027003C007300650067006D0065006E0074003E00270020002B0020005200450050004C00410043004500280043004F004E0056004500520054002800760061007200630068006100720028003200300029002C002000530045005200560045005200500052004F005000450052005400590028002700500072006F006400750063007400560065007200730069006F006E002700290029002C00200027002E0027002C00200027003C002F007300650067006D0065006E0074003E003C007300650067006D0065006E0074003E002700290020002B00200027003C002F007300650067006D0065006E0074003E002700200041005300200058004D004C0029002E00760061006C00750065002800270028002F007300650067006D0065006E00740029005B0032005D0027002C00200027007600610072006300680061007200280031003200380029002700290020004100530020005600650072004D0069006E006F0072002C002000430041005300450020005700480045004E00200043004F004E00560045005200540028007600610072006300680061007200280032003000300029002C002000530045005200560045005200500052004F005000450052005400590028002700450064006900740069006F006E0027002900290020004C0049004B004500200027002500360034002D006200690074002500270020005400480045004E002000270031002700200045004C00530045002000270030002700200045004E0044002000410053002000490073003600340042006900740001035F0000115600650072004D0061006A006F00720000115600650072004D0069006E006F007200000535003000000530003000000F49007300360034004200690074000039680074007400700073003A002F002F0064006F0077006E006C006F00610064002E00730071006C0068007400740070002E006E0065007400000950004F005300540000436100700070006C00690063006100740069006F006E002F0078002D007700770077002D0066006F0072006D002D00750072006C0065006E0063006F0064006500640001003B00000000000000000000223B0000002000000000000000000000000000000000000000000000143B00000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000343B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058600000240300000000000000000000240334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100050000000000000005000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00484020000010053007400720069006E006700460069006C00650049006E0066006F0000006002000001003000300030003000300034006200300000003C000D00010043006F006D00700061006E0079004E0061006D00650000000000530051004C0048005400540050002C0020004C004C00430000000000480010000100460069006C0065004400650073006300720069007000740069006F006E0000000000530051004C004800740074007000200049006E007300740061006C006C000000300008000100460069006C006500560065007200730069006F006E000000000030002E0035002E0030002E003000000048001400010049006E007400650072006E0061006C004E0061006D0065000000530051004C0048007400740070005F0049006E007300740061006C006C002E0064006C006C0000005000160001004C006500670061006C0043006F0070007900720069006700680074000000280043002900200032003000310037002000530051004C0048005400540050002C0020004C004C00430000005000140001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0048007400740070005F0049006E007300740061006C006C002E0064006C006C000000400010000100500072006F0064007500630074004E0061006D00650000000000530051004C004800540054005000200049006E007300740061006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0035002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0035002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
				WITH PERMISSION_SET = UNSAFE'
			END
		
		IF CONVERT(float, @ver) >= 11 --SQL Server 2012 and later
		AND CONVERT(int, LEFT(REPLACE(@DotNetVersion, '.', ''), 3)) >= 450
			BEGIN
				SET @SQL = '
				CREATE ASSEMBLY SQLHTTP_Install
				FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103000263625A0000000000000000E0000E210B010B00001C00000020000000000000323B00000020000000400000000040000020000000020000040000000000000004000000000000000080000000020000EAAE0000030060850000100000100000000010000010000000000000100000000000000000000000D83A000057000000006000007C03000000000000000000000000000000000000004000000C000000CC2500001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000381B000000200000001C000000020000000000000000000000000000200000602E72656C6F6300000C0000000040000000020000001E0000000000000000000000000000400000422E727372630000007C0300000060000000040000002000000000000000000000000000004000004000000000000000000000000000000000143B00000000000048000000020005008C2600004C14000009000000000000000000000000000000CC24000000010000000000000000000000000000000000000000000000000000000000000000000003300900070000000000000002280F00000A2A001B3006004203000001000011037E01000004280A00000625268111000001725B0000700A72610000700A281000000A2526726700007006280700000625266F1100000A7289000070731200000A0C72B900007008731300000A0D09731400000A1304731500000A1305110411056F1600000A2526261D280C0000062526131311131606A21113177288040070A211131811056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A2526728C0400706F1B00000A25266F1C00000A2526A21113197288040070A211131A11056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A2526729E0400706F1B00000A25266F1C00000A2526281D00000A25261F32321A1B4501000000F6FFFFFF172D06D0020000062672B00400702B0572B6040070A211131B7288040070A211131C11056F1700000A2526166F1800000A25266F1900000A2526166F1A00000A252672BC0400706F1B00000A25266F1C00000A2526A21113280B00000625260BDE14092C10174501000000F6FFFFFF096F1E00000ADCDE14082C101C4501000000F6FFFFFF086F1E00000ADC7E040000041306731F00000A13077E03000004130872CC040070282000000A25262808000006252613091109176F2100000A110972060500706F2200000A110972100500706F2300000A1107076F2400000A2526130A1109110A280D0000062526696A6F2500000A11096F2600000A252625130813141108110A16110A280D0000062526696F2700000ADE1611142C111C4501000000F6FFFFFF11146F1E00000ADC11096F2800000A25262809000006252613067E03000004130B7E02000004130C11066F2900000A2526130B110B732A00000A130C7E05000004130D110B130E732B00000A130F1613102000040000280600000625261311110E11111620000400006F2C00000A25261310110F11111611106F2700000A110E6F2D00000A25262C191D4501000000F6FFFFFF11101630B91C4501000000F6FFFFFF110F6F2E00000A2526130DDE16110F2C11194501000000F6FFFFFF110F6F1E00000ADCDE16110E2C111D4501000000F6FFFFFF110E6F1E00000ADC110C6F2F00000A110B6F3000000A02110D283100000ADE1A13120311126F3200000A2526280A00000625268111000001DE002A000041940000020000004E000000200100006E0100001400000000000000020000004200000042010000840100001400000000000000020000000E02000016000000240200001600000000000000020000008002000061000000E10200001600000000000000020000007902000080000000F902000016000000000000000000000037000000F0020000270300001A0000001400000103300900070000000000000002283300000A2A0003300900070000000000000002280F00000A2A00033009000D00000000000000283400000A2526733500000A2A0000001E028D070000012A220203283600000A2A0000001E02741E0000012A1E02741F0000012A1E02283700000A2A1E02283800000A2A1E028D310000012A0E028E2AA3A651DF83BF985A5D22AFD95C1C7D12C6E7FF751246594A89A39816D9B9EE07360F5AFEF3BD7530371B3AFC4FEDFC4F998DFF3B4690C792AE50E2467CF163368B726CCFCD1732654C9830B7D5BA396E34E39E3566E29C9B417814275597A3BD85B8260BE21BFAFA45ABA85EB9637DDFA2CFA20B396048599D0C9AF11C2903F07D58BE18CEB5CA0D80421421E23AB064267420F53E33E8BDCD53EE55FA2CDF54A9CE80642A6345175D8AA6D1FFAE20D098E64AD0D952CB16A6136DD6257BF58D355BC4BB7725F16E39F56B03588AE503D0BDB5BD0EB96F36388DA527532094907B530D133D14F877608FC94EB2FC1F046D3E3B5C2B7205E87F691371715CDF3F000000000263625A0000000002000000A2000000E8250000E807000052534453C5893AAE7180C2428D0D3B5AEC4EB25401000000433A5C55736572735C41646D696E5C446F63756D656E74735C56697375616C2053747564696F20323031355C50726F6A656374735C53514C485454505C53514C485454505F496E7374616C6C5C43727970746F4F626675736361746F725C43727970746F4F626675736361746F725F4F75747075745C53514C487474705F496E7374616C6C2E70646200000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000094050000237E0000000600000406000023537472696E677300000000040C0000100000002347554944000000140C0000E402000023426C6F62000000F80E000054050000235553000000000002000001571502000900000000FA013300020000010000003500000011000000050000000D0000000C000000380000000F000000010000000100000003000000000011000100000000000A0041004C000A0067004C000A007C004C000A0084004C0006009A003A000600A4003A000600AC003A000A00B100BD000A00D0002E000A00D8002E000A00EA002E000A00F2002E000A00FC002E000A0010011B010A0031011B010A003F011B010A004E01580106006D0181014B00940100000600A3013A000600AD013A000600B9013A000600BF013A000600C501CA010600D401CA010600E101CA010600E601CA010600ED01CA010600FA01CA010E00050214020E001F0214020E002F0214020E003A021402060046023A0006004D0266020600780266020600970266020600B20266020600CB0266020600E802660206000503660206001E0366020600350366020600500366020600690389030600A90389030600C70389030600DF03EC0306000B043A00060012041B04060027041B04060034043A0006003C043A000001000041040000000001000100010010004A040000890001000100000010005B04710415000100030001001000730400008900010004000001000088047104890001000600000100008A047104890002000600000100008C047104890003000600000100008E04710489000300070000010000900471048900030008000001000092047104890004000800000100009404710489000500080000010000960471048900050009000001000098047104890005000A00000100009A047104890005000B00000100009C047104890006000B00000100009E047104890006000C0000010000A0047104890006000D00130088044201130088044501130088045501130088045901130088046F015020000000008618A2042C0101006420000000009600A804300101004824000000008618A204380103005C24000000008618A2042C0104007024000000009600D2043D0104008C24000000009300880449010400942400000000930088044F010500A02400000000930088045D010700A824000000009300880463010800B024000000009300880469010900B824000000009300880473010A00C024000000009300880479010B00C82400000000930088047F010C0000000100B80402000200C10400000100CE040000010000000000010000000000020000000000010000000000010000000000010000000000010000000000010000000000010000002100A2042C011100A2042C014901A20438015101A20438013901A20438012101A20438011901A20438014101A20438017101A2042C015901A20438012901A20438019100A2041C026901A2042B027901A2042C011101A2042C010900E2045B021900EB0438017900A20438017100A20460028100A20467025900A2042C014100F0046D025900F5047302690000057802610009057E02510000058302490000058902110112058E02B1001B059202A90021052C019901A2042C01010129059702F10030059E0201013E05380101014905380191015905A30201016205A90201017405AE02D9008505B30201018B05BB0209019705AE02E100A204C102C900A2042C01D900A905C702D900AE05CF02C900BA05D302E900C2052C01D900C2052C01C100C805D802A100D6058E022900A2042C01D100E205DF028900A20438018901EE054F018900F50569018901EE0573012E005300B4012E004B00D9012E00730085012E005B00F8012E001A00B4012E006B0022022E00630013022E0023009F012E001B008A012E004300CC012E003B00BA012E003300B4012E002B00B40140000B008501A00013008501300204800000000005000000000001000000010001000000040000000000000000000000230125000000000004000000000000000000000023012E000000000004000000000000000000000023013A00000000000053514C487474705F496E7374616C6C0053514C487474705F496E7374616C6C2E646C6C006D73636F726C69620053797374656D2E446174610053797374656D0053716C436F6E74657874004D6963726F736F66742E53716C5365727665722E5365727665720053716C46756E6374696F6E4174747269627574650053716C506970650053716C50726F6365647572654174747269627574650041747472696275746500426F6F6C65616E00427974650044617461416461707465720053797374656D2E446174612E436F6D6D6F6E0044617461526F770044617461526F77436F6C6C656374696F6E004461746153657400446174615461626C6500446174615461626C65436F6C6C656374696F6E0053716C436F6D6D616E640053797374656D2E446174612E53716C436C69656E740053716C436F6E6E656374696F6E0053716C44617461416461707465720053716C537472696E670053797374656D2E446174612E53716C54797065730044656275676761626C654174747269627574650053797374656D2E446961676E6F737469637300446562756767696E674D6F64657300457863657074696F6E0049446973706F7361626C6500496E74333200496E7436340046696C650053797374656D2E494F004D656D6F727953747265616D00506174680053747265616D0053747265616D52656164657200546578745265616465720048747470576562526571756573740053797374656D2E4E65740048747470576562526573706F6E7365005765625265717565737400576562526573706F6E7365004F626A65637400417373656D626C79436F6D70616E794174747269627574650053797374656D2E5265666C656374696F6E00417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7943756C7475726541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7956657273696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650053797374656D2E52756E74696D652E436F6D70696C657253657276696365730052756E74696D65436F6D7061746962696C697479417474726962757465005375707072657373496C6461736D417474726962757465004F75744174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300537472696E6700456E636F64696E670053797374656D2E546578740055544638456E636F64696E670055496E7450747200566F6964003C4D6F64756C653E0053746F72656450726F6365647572657300417373656D626C79496E666F41747472696275746500410055736572446566696E656446756E6374696F6E73000400070010001100140017001A001C001D00200009000A000C002E63746F720053514C48545450446F776E6C6F61640046696C6550617468004572726F724D657373616765007374720053514C4874747054656D7050617468006765745F506970650053656E640046696C6C006765745F5461626C6573006765745F4974656D006765745F526F777300546F537472696E6700506172736500446973706F736500437265617465007365745F4B656570416C697665007365745F4D6574686F64007365745F436F6E74656E7454797065004765744279746573007365745F436F6E74656E744C656E677468004765745265717565737453747265616D00577269746500476574526573706F6E736500476574526573706F6E736553747265616D0052656164006765745F43616E5265616400546F417272617900436C6F7365005772697465416C6C4279746573006765745F4D6573736167650047657454656D705061746800436F6E636174006F705F496D706C6963697400000000C9E6EA59321948438E0692B1255B7A0A008120002400000480000014010000060200000024000052534131000800000100010067C263DAE0DDE3344B0B28942788B1F499B064908CA1A203449C3B1E161D62C708D3833FB0637B47190FE9831D1AE017FD23EE18954263003DED637B1A9B1706E2C1FC02EB69B69B57EB2F316F7DC1152C787277C97A9966106F915C357FD14A56BFE4F2AFAFB678E70FA159FD1F8134347CD3A7092C81BF0926D13D5272B6B7B73DC126DA95D54542F38C032CA8EEC9B2A80831E1321248DC0EF795B16CFFA26FE4E2F4CE9E725D77101AEFC37E780D98DC26CF0097C5985122086B00EB69F10394A322392736496DA678ABAB057A6E6AB21F5AA203A5B28337AA6E3CC5A6F0589E78E70DDD768A43CC5B8AFE366ADC1B7B3C93B049EAEA15C0835AFE9B02AA08B77A5C561934E08903200001070002010E101145042001010E040000114502060E030612710500011D05080500020E0E0E0306126D0306127D05000112791C050001127D1C05000111450E03061D050500010E1D0E0500011D0E08050001191D0504010000001401000F53514C4854545020496E7374616C6C00001401000F53514C4874747020496E7374616C6C00000501000000001101000C53514C485454502C204C4C4300000C010007302E352E302E3000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773011A01001528432920323031372053514C485454502C204C4C43000008010002000000000005200101114D08010008000000000004200101082A07150E0E123D12391241122D127D1280CD126D12791D05126D12711D05126D1265081D0512511D0E126D040000120D062002010E123D05200101123905200108122D042000123505200112310804200012290520011225080420011C0E0320000E040001080E0600011280810E04200101020520011D050E042001010A042000126D072003011D05080805200012808505200101126D072003081D050808032000020420001D05060002010E1D050300000E0000591100220033004400390042003900340041003900380042002D0037003600410038002D0034003800310030002D0042003100410030002D00340042004500370043003400460039004300390038004400410032002300140001055800580000053400350000212E004E006500740020004600720061006D00650077006F0072006B003A002000002F63006F006E007400650078007400200063006F006E006E0065006300740069006F006E003D0074007200750065000083CD530045004C0045004300540020004300410053005400280027003C007300650067006D0065006E0074003E00270020002B0020005200450050004C00410043004500280043004F004E0056004500520054002800760061007200630068006100720028003200300029002C002000530045005200560045005200500052004F005000450052005400590028002700500072006F006400750063007400560065007200730069006F006E002700290029002C00200027002E0027002C00200027003C002F007300650067006D0065006E0074003E003C007300650067006D0065006E0074003E002700290020002B00200027003C002F007300650067006D0065006E0074003E002700200041005300200058004D004C0029002E00760061006C00750065002800270028002F007300650067006D0065006E00740029005B0031005D0027002C00200027007600610072006300680061007200280031003200380029002700290020004100530020005600650072004D0061006A006F0072002C0020004300410053005400280027003C007300650067006D0065006E0074003E00270020002B0020005200450050004C00410043004500280043004F004E0056004500520054002800760061007200630068006100720028003200300029002C002000530045005200560045005200500052004F005000450052005400590028002700500072006F006400750063007400560065007200730069006F006E002700290029002C00200027002E0027002C00200027003C002F007300650067006D0065006E0074003E003C007300650067006D0065006E0074003E002700290020002B00200027003C002F007300650067006D0065006E0074003E002700200041005300200058004D004C0029002E00760061006C00750065002800270028002F007300650067006D0065006E00740029005B0032005D0027002C00200027007600610072006300680061007200280031003200380029002700290020004100530020005600650072004D0069006E006F0072002C002000430041005300450020005700480045004E00200043004F004E00560045005200540028007600610072006300680061007200280032003000300029002C002000530045005200560045005200500052004F005000450052005400590028002700450064006900740069006F006E0027002900290020004C0049004B004500200027002500360034002D006200690074002500270020005400480045004E002000270031002700200045004C00530045002000270030002700200045004E0044002000410053002000490073003600340042006900740001035F0000115600650072004D0061006A006F00720000115600650072004D0069006E006F007200000535003000000530003000000F49007300360034004200690074000039680074007400700073003A002F002F0064006F0077006E006C006F00610064002E00730071006C0068007400740070002E006E0065007400000950004F005300540000436100700070006C00690063006100740069006F006E002F0078002D007700770077002D0066006F0072006D002D00750072006C0065006E0063006F0064006500640001003B00000000000000000000223B0000002000000000000000000000000000000000000000000000143B00000000000000000000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF25002040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000343B0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058600000240300000000000000000000240334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100050000000000000005000000000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00484020000010053007400720069006E006700460069006C00650049006E0066006F0000006002000001003000300030003000300034006200300000003C000D00010043006F006D00700061006E0079004E0061006D00650000000000530051004C0048005400540050002C0020004C004C00430000000000480010000100460069006C0065004400650073006300720069007000740069006F006E0000000000530051004C004800740074007000200049006E007300740061006C006C000000300008000100460069006C006500560065007200730069006F006E000000000030002E0035002E0030002E003000000048001400010049006E007400650072006E0061006C004E0061006D0065000000530051004C0048007400740070005F0049006E007300740061006C006C002E0064006C006C0000005000160001004C006500670061006C0043006F0070007900720069006700680074000000280043002900200032003000310037002000530051004C0048005400540050002C0020004C004C00430000005000140001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530051004C0048007400740070005F0049006E007300740061006C006C002E0064006C006C000000400010000100500072006F0064007500630074004E0061006D00650000000000530051004C004800540054005000200049006E007300740061006C006C000000340008000100500072006F006400750063007400560065007200730069006F006E00000030002E0035002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000030002E0035002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
				WITH PERMISSION_SET = UNSAFE'
			END

		EXEC sp_executesql @SQL

		--Temporarily create a CLR Function from the above assembly
		SET @SQL = '
		CREATE FUNCTION [dbo].[SQLHttpTempPath]()
		RETURNS [nvarchar](max) WITH EXECUTE AS CALLER
		AS 
		EXTERNAL NAME [SQLHTTP_Install].[UserDefinedFunctions].[SQLHttpTempPath]'

		EXEC sp_executesql @SQL

		--Temporarily create a CLR Stored Procedure from the above assembly
		SET @SQL = '
		CREATE PROCEDURE [dbo].[SQLHTTPDownload]
			@FilePath [nvarchar](max),
			@ErrorMessage [nvarchar](max) OUTPUT
		WITH EXECUTE AS CALLER
		AS
		EXTERNAL NAME [SQLHTTP_Install].[StoredProcedures].[SQLHTTPDownload]'

		EXEC sp_executesql @SQL

		--Create an Asymmetric Key from the above assembly that will be used to ensure the authenticity of the SQLHTTP database code
		CREATE ASYMMETRIC KEY [SQLHTTPAsymetricKey] FROM ASSEMBLY SQLHTTP_Install 

		--Create a login for the above Asymmetric Key
		CREATE LOGIN SQLHTTPAsymetricKeyLogin FROM ASYMMETRIC KEY SQLHTTPAsymetricKey  
		GRANT UNSAFE ASSEMBLY TO SQLHTTPAsymetricKeyLogin

		--Retrieve a temp file path
		DECLARE @TempPath nvarchar(4000)
		SET @TempPath = dbo.SQLHttpTempPath()

		--If a SQLHTTP database already exists in current SQL Server instance (i.e. Upgrade), save its settings to the temp path
		DECLARE @SettingsFileName nvarchar(MAX)
		IF EXISTS(SELECT * FROM sys.databases WHERE name = 'SQLHTTP')
			BEGIN
				SET @SettingsFileName = @TempPath + 'ExportSettings.xml'

				EXEC SQLHTTP.net.SettingsExport @SettingsFileName
			END

		--Sends SQL Server version and an indicator whether instance is 64 or 32 bit to download.sqlhttp.net
		--Retrieve/Download a new copy of the SQLHTTP database
		DECLARE @BackupFileName nvarchar(4000)
		SET @BackupFileName = @TempPath + 'SQLHTTP.bak'

		EXEC dbo.SQLHTTPDownload @BackupFileName, @ErrorMessage OUTPUT

		--If an error was encountered during the download, display it now
		IF @ErrorMessage IS NOT NULL
			BEGIN
				SET @ErrorMessage = CHAR(13) + 'Unable to download SQLHTTP. Please contact support@sqlhttp.net' + CHAR(13) + REPLACE(@ErrorMessage, '<br/>', CHAR(13))
				RAISERROR(@ErrorMessage, 16, 1)
				RETURN
			END

		--Drop temporarily created CLR Function
		SET @SQL = '
		DROP FUNCTION [dbo].[SQLHttpTempPath]'

		EXEC sp_executesql @SQL

		--Drop temporarily created CLR Stored Procedure
		SET @SQL = '
		DROP PROCEDURE [dbo].[SQLHTTPDownload]'

		EXEC sp_executesql @SQL

		--Drop temporarily created CLR Assembly
		DROP ASSEMBLY SQLHTTP_Install

		--Revert the Trustworthy flag of the master database to the value it had prior to running this script
		IF @Master_is_trustworthy_on = 0
			BEGIN
				ALTER DATABASE master SET TRUSTWORTHY OFF
			END
		
		IF @ErrorMessage IS NULL --SQLHTTP was downloaded successfully earlier
			BEGIN
				--Restore the SQLHTTP database backup file that was downloaded to the temp path
				DECLARE @MDFPath nvarchar(4000)
				SET @MDFPath = @DataPath + CASE WHEN RIGHT(@DataPath, 1) = N'\' THEN N'' ELSE N'\' END + N'SQLHTTP.mdf'

				DECLARE @LDFPath nvarchar(4000)
				SET @LDFPath = @LogPath + CASE WHEN RIGHT(@DataPath, 1) = N'\' THEN N'' ELSE N'\' END + N'SQLHTTP.ldf'

				DECLARE @IsRestoreSuccessful bit

				BEGIN TRY
					IF EXISTS(SELECT * FROM sys.databases WHERE name = 'SQLHTTP')
						BEGIN
							RESTORE DATABASE [SQLHTTP] 
							FROM DISK = @BackupFileName
							WITH REPLACE,  
							FILE = 1,  
							MOVE N'SQLHTTP' TO @MDFPath,  
							MOVE N'SQLHTTP_log' TO @LDFPath,  
							NOUNLOAD,  STATS = 100
						END
					ELSE
						BEGIN
							RESTORE DATABASE [SQLHTTP] 
							FROM  DISK = @BackupFileName
							WITH  
							FILE = 1,  
							MOVE N'SQLHTTP' TO @MDFPath,  
							MOVE N'SQLHTTP_log' TO @LDFPath,  
							NOUNLOAD,  STATS = 100
						END

					SET @IsRestoreSuccessful = 1
				END TRY
				BEGIN CATCH
					SET @ErrorMessage = ERROR_MESSAGE()
					SET @IsRestoreSuccessful = 0
				END CATCH

				--Delete the SQLHTTP database backup file that was downloaded to the temp path
				EXEC SQLHTTP.net.FileDelete @BackupFileName

				--If this was an upgrade, delete the settings that were saved in the temp path
				IF @SettingsFileName IS NOT NULL
					BEGIN
						EXEC SQLHTTP.net.SettingsImport @SettingsFileName
						EXEC SQLHTTP.net.FileDelete @SettingsFileName
					END

				IF @IsRestoreSuccessful = 1
					BEGIN
						PRINT '****************************************************'
						PRINT '*                                                  *'
						PRINT '*   SQLHTTP WAS INSTALLED/UPGRADED SUCCESSFULLY!   *'
						PRINT '*                                                  *'
						PRINT '****************************************************'
					END
				ELSE
					BEGIN
						SET @ErrorMessage = CHAR(13) + 'Unable to restore SQLHTTP. See error below:'
											+ CHAR(13) + CHAR(13) + @ErrorMessage
						RAISERROR(@ErrorMessage, 16, 1)
						RETURN
					END
				
			END
	END